



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://opensource.zalando.com/skipper/reference/development/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.0.1, mkdocs-material-3.0.6">
    
    
      
        <title>Development - Skipper</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#how-to-develop-a-filter" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://opensource.zalando.com/skipper/" title="Skipper" class="md-header-nav__button md-logo">
          
            <img src="../../favicon.ico" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Skipper
              </span>
              <span class="md-header-nav__topic">
                Development
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/zalando/skipper/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="Introduction" class="md-tabs__link">
        Introduction
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../filters/" title="Reference" class="md-tabs__link md-tabs__link--active">
          Reference
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../kubernetes/ingress-controller/" title="Kubernetes" class="md-tabs__link">
          Kubernetes
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../tutorials/basics/" title="Tutorials" class="md-tabs__link">
          Tutorials
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://opensource.zalando.com/skipper/" title="Skipper" class="md-nav__button md-logo">
      
        <img src="../../favicon.ico" width="48" height="48">
      
    </a>
    Skipper
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/zalando/skipper/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../filters/" title="Filters" class="md-nav__link">
      Filters
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../predicates/" title="Predicates" class="md-nav__link">
      Predicates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../backends/" title="Backends" class="md-nav__link">
      Backends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../egress/" title="Egress" class="md-nav__link">
      Egress
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../scripts/" title="Scripts" class="md-nav__link">
      Scripts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../plugins/" title="Plugins" class="md-nav__link">
      Plugins
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Development
      </label>
    
    <a href="./" title="Development" class="md-nav__link md-nav__link--active">
      Development
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-develop-a-filter" title="How to develop a Filter" class="md-nav__link">
    How to develop a Filter
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-pass-options-to-your-filter" title="How to pass options to your filter" class="md-nav__link">
    How to pass options to your filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-documentation" title="User documentation" class="md-nav__link">
    User documentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-godoc" title="Add godoc" class="md-nav__link">
    Add godoc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter-implementation" title="Filter implementation" class="md-nav__link">
    Filter implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-tests" title="Writing tests" class="md-nav__link">
    Writing tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-debugger" title="Using a debugger" class="md-nav__link">
    Using a debugger
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tutorials/video-howto-build/" title="Video - How to build" class="md-nav__link">
      Video - How to build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-10" type="checkbox" id="nav-2-10">
    
    <label class="md-nav__link" for="nav-2-10">
      Data Clients
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-10">
        Data Clients
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../data-clients/eskip-file/" title="Eskip File" class="md-nav__link">
      Eskip File
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../data-clients/etcd/" title="Etcd" class="md-nav__link">
      Etcd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../data-clients/kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../data-clients/route-string/" title="Route String" class="md-nav__link">
      Route String
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-11" type="checkbox" id="nav-2-11">
    
    <label class="md-nav__link" for="nav-2-11">
      Operation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-11">
        Operation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../operation/deployment/" title="Deployment" class="md-nav__link">
      Deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../operation/operation/" title="Operation" class="md-nav__link">
      Operation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Kubernetes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Kubernetes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/ingress-controller/" title="Ingress Controller Deployment" class="md-nav__link">
      Ingress Controller Deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/ingress-usage/" title="Ingress Usage" class="md-nav__link">
      Ingress Usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/ingress-backends/" title="Ingress Backends" class="md-nav__link">
      Ingress Backends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/routegroups/" title="RouteGroups" class="md-nav__link">
      RouteGroups
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/routegroup-crd/" title="RouteGroup CRD Semantics" class="md-nav__link">
      RouteGroup CRD Semantics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/east-west-usage/" title="East-West aka svc-to-svc" class="md-nav__link">
      East-West aka svc-to-svc
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tutorials/basics/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tutorials/common-use-cases/" title="Common Use Cases" class="md-nav__link">
      Common Use Cases
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tutorials/auth/" title="Authentication and Autorization" class="md-nav__link">
      Authentication and Autorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tutorials/ratelimit/" title="Ratelimits" class="md-nav__link">
      Ratelimits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tutorials/operations/" title="Operations" class="md-nav__link">
      Operations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tutorials/development/" title="Development" class="md-nav__link">
      Development
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-develop-a-filter" title="How to develop a Filter" class="md-nav__link">
    How to develop a Filter
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-pass-options-to-your-filter" title="How to pass options to your filter" class="md-nav__link">
    How to pass options to your filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-documentation" title="User documentation" class="md-nav__link">
    User documentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-godoc" title="Add godoc" class="md-nav__link">
    Add godoc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter-implementation" title="Filter implementation" class="md-nav__link">
    Filter implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-tests" title="Writing tests" class="md-nav__link">
    Writing tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-debugger" title="Using a debugger" class="md-nav__link">
    Using a debugger
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zalando/skipper/edit/master/docs/reference/development.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Development</h1>
                
                <h2 id="how-to-develop-a-filter">How to develop a Filter<a class="headerlink" href="#how-to-develop-a-filter" title="Permanent link">&para;</a></h2>
<p>A filter is part of a route and can change arbitary http data in the
<code>http.Request</code> and <code>http.Response</code> path of a proxy.</p>
<p>The filter example shows a non trivial diff of a filter
implementation, that implements an authnz webhook. It shows global
settings passed via flags, user documentation, developer documentation
for library users, the filter implementation and some test
cases. Tests should test the actual filter implementation in a proxy
setup.</p>
<h3 id="how-to-pass-options-to-your-filter">How to pass options to your filter<a class="headerlink" href="#how-to-pass-options-to-your-filter" title="Permanent link">&para;</a></h3>
<p>Set a <code>default</code> and a <code>Usage</code> string as const.  Add a var to hold the
value and put the flag to the category, that makes the most sense.</p>
<p>If a filter, predicate or dataclient need <code>Options</code> passed from flags,
then you should register the filter in <code>skipper.go</code>, the main library
entrypoint. In case you do not need options from flags, use
<code>MakeRegistry()</code> in <code>./filters/builtin/builtin.go</code> to register your
filter.</p>
<div class="codehilite"><pre><span></span><span class="gh">diff --git a/cmd/skipper/main.go b/cmd/skipper/main.go</span>
<span class="gh">index 28f18f9..4530b85 100644</span>
<span class="gd">--- a/cmd/skipper/main.go</span>
<span class="gi">+++ b/cmd/skipper/main.go</span>
<span class="gu">@@ -59,9 +59,10 @@ const (</span>
    defaultOAuthTokeninfoTimeout          = 2 * time.Second
    defaultOAuthTokenintrospectionTimeout = 2 * time.Second
<span class="gi">+   defaultWebhookTimeout                 = 2 * time.Second</span>

    // generic:
    addressUsage                         = &quot;network address that skipper should listen on&quot;
<span class="gu">@@ -141,6 +142,8 @@ const (</span>
    oauth2TokeninfoURLUsage              = &quot;sets the default tokeninfo URL to query information about an incoming OAuth2 token in oauth2Tokeninfo filters&quot;
    oauth2TokeninfoTimeoutUsage          = &quot;sets the default tokeninfo request timeout duration to 2000ms&quot;
    oauth2TokenintrospectionTimeoutUsage = &quot;sets the default tokenintrospection request timeout duration to 2000ms&quot;
<span class="gi">+   webhookTimeoutUsage                  = &quot;sets the webhook request timeout duration, defaults to 2s&quot;</span>
<span class="gi">+</span>
    // connections, timeouts:
    idleConnsPerHostUsage           = &quot;maximum idle connections per backend host&quot;
    closeIdleConnsPeriodUsage       = &quot;period of closing all idle connections in seconds or as a duration string. Not closing when less than 0&quot;
<span class="gu">@@ -243,13 +246,14 @@ var (</span>
    oauth2TokeninfoURL              string
    oauth2TokeninfoTimeout          time.Duration
    oauth2TokenintrospectionTimeout time.Duration
<span class="gi">+   webhookTimeout                  time.Duration</span>

    // connections, timeouts:
    idleConnsPerHost           int
<span class="gu">@@ -351,13 +355,14 @@ func init() {</span>
    flag.DurationVar(&amp;oauth2TokeninfoTimeout, &quot;oauth2-tokeninfo-timeout&quot;, defaultOAuthTokeninfoTimeout, oauth2TokeninfoTimeoutUsage)
    flag.DurationVar(&amp;oauth2TokenintrospectionTimeout, &quot;oauth2-tokenintrospect-timeout&quot;, defaultOAuthTokenintrospectionTimeout, oauth2TokenintrospectionTimeoutUsage)
<span class="gi">+   flag.DurationVar(&amp;webhookTimeout, &quot;webhook-timeout&quot;, defaultWebhookTimeout, webhookTimeoutUsage)</span>

    // connections, timeouts:
    flag.IntVar(&amp;idleConnsPerHost, &quot;idle-conns-num&quot;, proxy.DefaultIdleConnsPerHost, idleConnsPerHostUsage)
<span class="gu">@@ -536,13 +541,14 @@ func main() {</span>
        OAuthTokeninfoURL:              oauth2TokeninfoURL,
        OAuthTokeninfoTimeout:          oauth2TokeninfoTimeout,
        OAuthTokenintrospectionTimeout: oauth2TokenintrospectionTimeout,
<span class="gi">+       WebhookTimeout:                 webhookTimeout,</span>

        // connections, timeouts:
        IdleConnectionsPerHost:     idleConnsPerHost,

<span class="gh">diff --git a/skipper.go b/skipper.go</span>
<span class="gh">index 10d5769..da46fe0 100644</span>
<span class="gd">--- a/skipper.go</span>
<span class="gi">+++ b/skipper.go</span>
<span class="gu">@@ -443,6 +443,9 @@ type Options struct {</span>
    // OAuthTokenintrospectionTimeout sets timeout duration while calling oauth tokenintrospection service
    OAuthTokenintrospectionTimeout time.Duration

<span class="gi">+   // WebhookTimeout sets timeout duration while calling a custom webhook auth service</span>
<span class="gi">+   WebhookTimeout time.Duration</span>
<span class="gi">+</span>
    // MaxAuditBody sets the maximum read size of the body read by the audit log filter
    MaxAuditBody int
 }
<span class="gu">@@ -677,7 +680,8 @@ func Run(o Options) error {</span>
        auth.NewOAuthTokenintrospectionAnyClaims(o.OAuthTokenintrospectionTimeout),
        auth.NewOAuthTokenintrospectionAllClaims(o.OAuthTokenintrospectionTimeout),
        auth.NewOAuthTokenintrospectionAnyKV(o.OAuthTokenintrospectionTimeout),
<span class="gd">-       auth.NewOAuthTokenintrospectionAllKV(o.OAuthTokenintrospectionTimeout))</span>
<span class="gi">+       auth.NewOAuthTokenintrospectionAllKV(o.OAuthTokenintrospectionTimeout),</span>
<span class="gi">+       auth.NewWebhook(o.WebhookTimeout))</span>

    // create a filter registry with the available filter specs registered,
    // and register the custom filters
</pre></div>

<h3 id="user-documentation">User documentation<a class="headerlink" href="#user-documentation" title="Permanent link">&para;</a></h3>
<p>Documentation for users should be done in <code>docs/</code>.</p>
<div class="codehilite"><pre><span></span><span class="gh">diff --git a/docs/filters.md b/docs/filters.md</span>
<span class="gh">index d3bb872..a877062 100644</span>
<span class="gd">--- a/docs/filters.md</span>
<span class="gi">+++ b/docs/filters.md</span>
<span class="gu">@@ -382,6 +382,24 @@ basicAuth(&quot;/path/to/htpasswd&quot;)</span>
 basicAuth(&quot;/path/to/htpasswd&quot;, &quot;My Website&quot;)
 ```

<span class="gi">+## webhook</span>
<span class="gi">+</span>
<span class="gi">+The `webhook` filter makes it possible to have your own authentication and</span>
<span class="gi">+authorization endpoint as a filter.</span>
<span class="gi">+</span>
<span class="gi">+Headers from the incoming request will be copied into the request that</span>
<span class="gi">+is being done to the webhook endpoint. Responses from the webhook with</span>
<span class="gi">+status code less than 300 will be authorized, rest unauthorized.</span>
<span class="gi">+</span>
<span class="gi">+Examples:</span>
<span class="gi">+</span>
<span class="gi">+```</span>
<span class="gi">+webhook(&quot;https://custom-webhook.example.org/auth&quot;)</span>
<span class="gi">+```</span>
<span class="gi">+</span>
<span class="gi">+The webhook timeout has a default of 2 seconds and can be globally</span>
<span class="gi">+changed, if skipper is started with `-webhook-timeout=2s` flag.</span>
<span class="gi">+</span>
 ## oauthTokeninfoAnyScope

 If skipper is started with `-oauth2-tokeninfo-url` flag, you can use
</pre></div>

<h3 id="add-godoc">Add godoc<a class="headerlink" href="#add-godoc" title="Permanent link">&para;</a></h3>
<p>Godoc is meant for developers using skipper as library, use <code>doc.go</code>
of the package to document generic functionality, usage and library
usage.</p>
<div class="codehilite"><pre><span></span><span class="gh">diff --git a/filters/auth/doc.go b/filters/auth/doc.go</span>
<span class="gh">index 696d3fd..1d6e3a8 100644</span>
<span class="gd">--- a/filters/auth/doc.go</span>
<span class="gi">+++ b/filters/auth/doc.go</span>
<span class="gu">@@ -318,5 +318,12 @@ filter after the auth filter.</span>
     a: Path(&quot;/only-allowed-audit-log&quot;) -&gt; oauthTokeninfoAnyScope(&quot;bar-w&quot;) -&gt; auditLog() -&gt; &quot;https://internal.example.org/&quot;;
     b: Path(&quot;/all-access-requests-audit-log&quot;) -&gt; auditLog() -&gt; oauthTokeninfoAnyScope(&quot;foo-r&quot;) -&gt; &quot;https://internal.example.org/&quot;;

<span class="gi">+Webhook - webhook() filter</span>
<span class="gi">+</span>
<span class="gi">+The filter webhook allows you to have a custom authentication and</span>
<span class="gi">+authorization endpoint for a route.</span>
<span class="gi">+</span>
<span class="gi">+    a: Path(&quot;/only-allowed-by-webhook&quot;) -&gt; webhook(&quot;https://custom-webhook.example.org/auth&quot;) -&gt; &quot;https://protected-backend.example.org/&quot;;</span>
<span class="gi">+</span>
 */
 package auth
</pre></div>

<h3 id="filter-implementation">Filter implementation<a class="headerlink" href="#filter-implementation" title="Permanent link">&para;</a></h3>
<p>A filter can modify the incoming <code>http.Request</code> before calling the
backend and the outgoing <code>http.Response</code> from the backend to the client.</p>
<p>A filter consists of at least two types a <code>spec</code> and a <code>filter</code>.
Spec consists of everything that is needed and known before a user
will instantiate a filter.</p>
<p>A spec will be created in the bootstrap procedure of a skipper
process. A spec has to satisfy the <code>Spec</code> interface <code>Name() string</code> and
<code>CreateFilter([]interface{}) (filters.Filter, error)</code>.</p>
<p>The actual filter implementation has to satisfy the <code>Filter</code>
interface <code>Request(filters.FilterContext)</code> and <code>Response(filters.FilterContext)</code>.
If you need to clean up for example a goroutine you can do it in
<code>Close()</code>, which will be called on filter shutdown.</p>
<div class="codehilite"><pre><span></span><span class="gh">diff --git a/filters/auth/webhook.go b/filters/auth/webhook.go</span>
new file mode 100644
<span class="gh">index 0000000..f0632a6</span>
<span class="gd">--- /dev/null</span>
<span class="gi">+++ b/filters/auth/webhook.go</span>
<span class="gu">@@ -0,0 +1,84 @@</span>
<span class="gi">+package auth</span>
<span class="gi">+</span>
<span class="gi">+import (</span>
<span class="gi">+   &quot;net/http&quot;</span>
<span class="gi">+   &quot;time&quot;</span>
<span class="gi">+</span>
<span class="gi">+   &quot;github.com/zalando/skipper/filters&quot;</span>
<span class="gi">+)</span>
<span class="gi">+</span>
<span class="gi">+const (</span>
<span class="gi">+   WebhookName = &quot;webhook&quot;</span>
<span class="gi">+)</span>
<span class="gi">+</span>
<span class="gi">+type (</span>
<span class="gi">+   webhookSpec struct {</span>
<span class="gi">+       Timeout time.Duration</span>
<span class="gi">+   }</span>
<span class="gi">+   webhookFilter struct {</span>
<span class="gi">+       authClient *authClient</span>
<span class="gi">+   }</span>
<span class="gi">+)</span>
<span class="gi">+</span>
<span class="gi">+// NewWebhook creates a new auth filter specification</span>
<span class="gi">+// to validate authorization for requests.</span>
<span class="gi">+func NewWebhook(d time.Duration) filters.Spec {</span>
<span class="gi">+   return &amp;webhookSpec{Timeout: d}</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+func (*webhookSpec) Name() string {</span>
<span class="gi">+   return WebhookName</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+// CreateFilter creates an auth filter. The first argument is an URL</span>
<span class="gi">+// string.</span>
<span class="gi">+//</span>
<span class="gi">+//     s.CreateFilter(&quot;https://my-auth-service.example.org/auth&quot;)</span>
<span class="gi">+//</span>
<span class="gi">+func (ws *webhookSpec) CreateFilter(args []interface{}) (filters.Filter, error) {</span>
<span class="gi">+   if l := len(args); l == 0 || l &gt; 2 {</span>
<span class="gi">+       return nil, filters.ErrInvalidFilterParameters</span>
<span class="gi">+   }</span>
<span class="gi">+</span>
<span class="gi">+   s, ok := args[0].(string)</span>
<span class="gi">+   if !ok {</span>
<span class="gi">+       return nil, filters.ErrInvalidFilterParameters</span>
<span class="gi">+   }</span>
<span class="gi">+</span>
<span class="gi">+   ac, err := newAuthClient(s, ws.Timeout)</span>
<span class="gi">+   if err != nil {</span>
<span class="gi">+       return nil, filters.ErrInvalidFilterParameters</span>
<span class="gi">+   }</span>
<span class="gi">+</span>
<span class="gi">+   return &amp;webhookFilter{authClient: ac}, nil</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+func copyHeader(to, from http.Header) {</span>
<span class="gi">+   for k, v := range from {</span>
<span class="gi">+       to[http.CanonicalHeaderKey(k)] = v</span>
<span class="gi">+   }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+func (f *webhookFilter) Request(ctx filters.FilterContext) {</span>
<span class="gi">+   statusCode, err := f.authClient.getWebhook(ctx.Request())</span>
<span class="gi">+   if err != nil {</span>
<span class="gi">+       unauthorized(ctx, WebhookName, authServiceAccess, f.authClient.url.Hostname())</span>
<span class="gi">+   }</span>
<span class="gi">+   // redirects, auth errors, webhook errors</span>
<span class="gi">+   if statusCode &gt;= 300 {</span>
<span class="gi">+       unauthorized(ctx, WebhookName, invalidAccess, f.authClient.url.Hostname())</span>
<span class="gi">+   }</span>
<span class="gi">+   authorized(ctx, WebhookName)</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+func (*webhookFilter) Response(filters.FilterContext) {}</span>
<span class="gi">+</span>
<span class="gi">+// Close cleans-up the quit channel used for this filter</span>
<span class="gi">+func (f *webhookFilter) Close() {</span>
<span class="gi">+   f.authClient.mu.Lock()</span>
<span class="gi">+   if f.authClient.quit != nil {</span>
<span class="gi">+       close(f.authClient.quit)</span>
<span class="gi">+       f.authClient.quit = nil</span>
<span class="gi">+   }</span>
<span class="gi">+   f.authClient.mu.Unlock()</span>
<span class="gi">+}</span>
</pre></div>

<h3 id="writing-tests">Writing tests<a class="headerlink" href="#writing-tests" title="Permanent link">&para;</a></h3>
<p>Skipper uses normal table driven Go tests without frameworks.</p>
<p>This example filter test creates a backend, an auth service to be
called by our filter, and a filter configured by our table driven test.</p>
<p>In general we use real backends with dynamic port allocations. We call
these and inspect the <code>http.Response</code> to check, if we get expected
results for invalid and valid data.</p>
<p>Skipper has some helpers to create the test proxy in the <code>proxytest</code>
package. Backends can be created with <code>httptest.NewServer</code> as in the
example below.</p>
<div class="codehilite"><pre><span></span><span class="gh">diff --git a/filters/auth/webhook_test.go b/filters/auth/webhook_test.go</span>
new file mode 100644
<span class="gh">index 0000000..d43c4ea</span>
<span class="gd">--- /dev/null</span>
<span class="gi">+++ b/filters/auth/webhook_test.go</span>
<span class="gu">@@ -0,0 +1,128 @@</span>
<span class="gi">+package auth</span>
<span class="gi">+</span>
<span class="gi">+import (</span>
<span class="gi">+   &quot;fmt&quot;</span>
<span class="gi">+   &quot;io&quot;</span>
<span class="gi">+   &quot;net/http&quot;</span>
<span class="gi">+   &quot;net/http/httptest&quot;</span>
<span class="gi">+   &quot;net/url&quot;</span>
<span class="gi">+   &quot;testing&quot;</span>
<span class="gi">+   &quot;time&quot;</span>
<span class="gi">+</span>
<span class="gi">+   &quot;github.com/zalando/skipper/eskip&quot;</span>
<span class="gi">+   &quot;github.com/zalando/skipper/filters&quot;</span>
<span class="gi">+   &quot;github.com/zalando/skipper/proxy/proxytest&quot;</span>
<span class="gi">+)</span>
<span class="gi">+</span>
<span class="gi">+func TestWebhook(t *testing.T) {</span>
<span class="gi">+   for _, ti := range []struct {</span>
<span class="gi">+       msg        string</span>
<span class="gi">+       token      string</span>
<span class="gi">+       expected   int</span>
<span class="gi">+       authorized bool</span>
<span class="gi">+       timeout    bool</span>
<span class="gi">+   }{{</span>
<span class="gi">+       msg:        &quot;invalid-token-should-be-unauthorized&quot;,</span>
<span class="gi">+       token:      &quot;invalid-token&quot;,</span>
<span class="gi">+       expected:   http.StatusUnauthorized,</span>
<span class="gi">+       authorized: false,</span>
<span class="gi">+   }, {</span>
<span class="gi">+       msg:        &quot;valid-token-should-be-authorized&quot;,</span>
<span class="gi">+       token:      testToken,</span>
<span class="gi">+       expected:   http.StatusOK,</span>
<span class="gi">+       authorized: true,</span>
<span class="gi">+   }, {</span>
<span class="gi">+       msg:        &quot;webhook-timeout-should-be-unauthorized&quot;,</span>
<span class="gi">+       token:      testToken,</span>
<span class="gi">+       expected:   http.StatusUnauthorized,</span>
<span class="gi">+       authorized: false,</span>
<span class="gi">+       timeout:    true,</span>
<span class="gi">+   }} {</span>
<span class="gi">+       t.Run(ti.msg, func(t *testing.T) {</span>
<span class="gi">+           backend := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, _ *http.Request) {</span>
<span class="gi">+               w.WriteHeader(http.StatusOK)</span>
<span class="gi">+               io.WriteString(w, &quot;Hello from backend&quot;)</span>
<span class="gi">+               return</span>
<span class="gi">+           }))</span>
<span class="gi">+           defer backend.Close()</span>
<span class="gi">+</span>
<span class="gi">+           authServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {</span>
<span class="gi">+               if ti.timeout {</span>
<span class="gi">+                   time.Sleep(time.Second + time.Millisecond)</span>
<span class="gi">+               }</span>
<span class="gi">+</span>
<span class="gi">+               if r.Method != &quot;GET&quot; {</span>
<span class="gi">+                   w.WriteHeader(489)</span>
<span class="gi">+                   io.WriteString(w, &quot;FAIL - not a GET request&quot;)</span>
<span class="gi">+                   return</span>
<span class="gi">+               }</span>
<span class="gi">+</span>
<span class="gi">+               tok := r.Header.Get(authHeaderName)</span>
<span class="gi">+               tok = tok[len(authHeaderPrefix):len(tok)]</span>
<span class="gi">+               switch tok {</span>
<span class="gi">+               case testToken:</span>
<span class="gi">+                   w.WriteHeader(200)</span>
<span class="gi">+                   fmt.Fprintln(w, &quot;OK - Got token: &quot;+tok)</span>
<span class="gi">+                   return</span>
<span class="gi">+               }</span>
<span class="gi">+               w.WriteHeader(402)                            //http.StatusUnauthorized)</span>
<span class="gi">+               fmt.Fprintln(w, &quot;Unauthorized - Got token: &quot;) //+tok)</span>
<span class="gi">+           }))</span>
<span class="gi">+           defer authServer.Close()</span>
<span class="gi">+</span>
<span class="gi">+           spec := NewWebhook(time.Second)</span>
<span class="gi">+</span>
<span class="gi">+           args := []interface{}{</span>
<span class="gi">+               &quot;http://&quot; + authServer.Listener.Addr().String(),</span>
<span class="gi">+           }</span>
<span class="gi">+           f, err := spec.CreateFilter(args)</span>
<span class="gi">+           if err != nil {</span>
<span class="gi">+               t.Errorf(&quot;error in creating filter for %s: %v&quot;, ti.msg, err)</span>
<span class="gi">+               return</span>
<span class="gi">+           }</span>
<span class="gi">+</span>
<span class="gi">+           f2 := f.(*webhookFilter)</span>
<span class="gi">+           defer f2.Close()</span>
<span class="gi">+</span>
<span class="gi">+           fr := make(filters.Registry)</span>
<span class="gi">+           fr.Register(spec)</span>
<span class="gi">+           r := &amp;eskip.Route{Filters: []*eskip.Filter{{Name: spec.Name(), Args: args}}, Backend: backend.URL}</span>
<span class="gi">+</span>
<span class="gi">+           proxy := proxytest.New(fr, r)</span>
<span class="gi">+           defer proxy.Close()</span>
<span class="gi">+</span>
<span class="gi">+           reqURL, err := url.Parse(proxy.URL)</span>
<span class="gi">+           if err != nil {</span>
<span class="gi">+               t.Errorf(&quot;Failed to parse url %s: %v&quot;, proxy.URL, err)</span>
<span class="gi">+               return</span>
<span class="gi">+           }</span>
<span class="gi">+</span>
<span class="gi">+           req, err := http.NewRequest(&quot;GET&quot;, reqURL.String(), nil)</span>
<span class="gi">+           if err != nil {</span>
<span class="gi">+               t.Errorf(&quot;failed to create request %v&quot;, err)</span>
<span class="gi">+               return</span>
<span class="gi">+           }</span>
<span class="gi">+           req.Header.Set(authHeaderName, authHeaderPrefix+ti.token)</span>
<span class="gi">+</span>
<span class="gi">+           rsp, err := http.DefaultClient.Do(req)</span>
<span class="gi">+           if err != nil {</span>
<span class="gi">+               t.Errorf(&quot;failed to get response: %v&quot;, err)</span>
<span class="gi">+               return</span>
<span class="gi">+           }</span>
<span class="gi">+           defer rsp.Body.Close()</span>
<span class="gi">+</span>
<span class="gi">+           buf := make([]byte, 128)</span>
<span class="gi">+           var n int</span>
<span class="gi">+           if n, err = rsp.Body.Read(buf); err != nil &amp;&amp; err != io.EOF {</span>
<span class="gi">+               t.Errorf(&quot;Could not read response body: %v&quot;, err)</span>
<span class="gi">+               return</span>
<span class="gi">+           }</span>
<span class="gi">+</span>
<span class="gi">+           t.Logf(&quot;%d %d&quot;, rsp.StatusCode, ti.expected)</span>
<span class="gi">+           if rsp.StatusCode != ti.expected {</span>
<span class="gi">+               t.Errorf(&quot;unexpected status code: %v != %v %d %s&quot;, rsp.StatusCode, ti.expected, n, buf)</span>
<span class="gi">+               return</span>
<span class="gi">+           }</span>
<span class="gi">+       })</span>
<span class="gi">+   }</span>
<span class="gi">+}</span>
</pre></div>

<h3 id="using-a-debugger">Using a debugger<a class="headerlink" href="#using-a-debugger" title="Permanent link">&para;</a></h3>
<p>Skipper supports plugins and to offer this support it uses the <a href="https://golang.org/pkg/plugin/"><code>plugin</code></a>
library. Due to a bug in the Go compiler as reported <a href="https://github.com/golang/go/issues/23733">here</a> a
debugger cannot be used. This issue will be fixed in Go 1.12 but until then the only workaround is to remove
references to the <code>plugin</code> library. The following patch can be used for debugging.</p>
<div class="codehilite"><pre><span></span><span class="gh">diff --git a/plugins.go b/plugins.go</span>
<span class="gh">index 837b6cf..aa69f09 100644</span>
<span class="gd">--- a/plugins.go</span>
<span class="gi">+++ b/plugins.go</span>
<span class="gu">@@ -1,5 +1,6 @@</span>
 package skipper

<span class="gi">+/*</span>
 import (
    &quot;fmt&quot;
    &quot;io/ioutil&quot;
<span class="gu">@@ -13,8 +14,13 @@ import (</span>
    &quot;github.com/zalando/skipper/filters&quot;
    &quot;github.com/zalando/skipper/routing&quot;
 )
<span class="gi">+*/</span>

 func (o *Options) findAndLoadPlugins() error {
<span class="gi">+   return nil</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+/*</span>
    found := make(map[string]string)
    done := make(map[string][]string)

<span class="gu">@@ -366,3 +372,4 @@ func readPluginConfig(plugin string) (conf []string, err error) {</span>
    }
    return conf, nil
 }
<span class="gi">+*/</span>
</pre></div>

<p>The patch can be applied with the <code>git apply $PATCH_FILE</code> command. Please do not commit the
modified <code>plugins.go</code> along with your changes.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../architecture/" title="Architecture" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Architecture
              </span>
            </div>
          </a>
        
        
          <a href="../../tutorials/video-howto-build/" title="Video - How to build" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Video - How to build
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.5e60981f.js"></script>
      
      <script>app.initialize({version:"1.0.1",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>